let map;
let markers = [];

// This matches your route objects in app.js/index.html!
const routes = [
  {
    from: 'Kengeri',
    to: 'Yelahanka',
    buses: ['401K', '401KB', '401M'],
    routeCoordinates: [
      { lat: 12.9236, lng: 77.4987 },
      { lat: 12.9300, lng: 77.5100 },
      { lat: 12.9400, lng: 77.5200 },
      { lat: 12.9450, lng: 77.5300 },
      { lat: 12.9539, lng: 77.6309 },
      { lat: 12.9600, lng: 77.5800 },
      { lat: 12.9700, lng: 77.5600 },
      { lat: 13.0035, lng: 77.5800 },
      { lat: 13.1035, lng: 77.5762 },
    ],
  },
  // Add your other routes the same way
];

// Get URL params
function getQueryParams() {
  const urlParams = new URLSearchParams(window.location.search);
  return {
    fromLocation: urlParams.get('from'),
    toLocation: urlParams.get('to'),
  };
}

function initMap(center) {
  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 12,
    center: center,
  });
}

function displayBusRoutes() {
  const { fromLocation, toLocation } = getQueryParams();
  const busList = document.getElementById('bus-list');
  const routeInfo = document.getElementById('route-info');
  const searchBtn = document.getElementById('search-again-btn');

  let route =
    routes.find(r => r.from === fromLocation && r.to === toLocation) ||
    routes.find(r => r.from === toLocation && r.to === fromLocation);

  if (!route) {
    routeInfo.textContent = "No buses available for this route";
    searchBtn.style.display = "block";
    return;
  }

  routeInfo.textContent = `${fromLocation} to ${toLocation} - Bus Routes:`;
  busList.innerHTML = "";

  // Create bus buttons
  route.buses.forEach(bus => {
    const button = document.createElement('button');
    button.textContent = bus;
    button.className = 'bus-btn';
    button.onclick = function () {
      showRouteOnMap(route.routeCoordinates);
    };
    busList.appendChild(button);
  });

  // Show "Search Again" button
  searchBtn.style.display = "block";
  searchBtn.onclick = () => {
    window.location.href = "index.html";
  };
}

function showRouteOnMap(coordinates) {
  if (!map) initMap(coordinates[0]);
  document.getElementById("map").style.display = "block";

  // Clear previous markers
  markers.forEach(marker => marker.setMap(null));
  markers = [];

  // Add markers
  coordinates.forEach(coord => {
    const marker = new google.maps.Marker({
      position: coord,
      map: map,
    });
    markers.push(marker);
  });

  // Draw polyline
  const busRouteLine = new google.maps.Polyline({
    path: coordinates,
    geodesic: true,
    strokeColor: "#4CAF50",
    strokeOpacity: 0.9,
    strokeWeight: 4,
    map: map,
  });

  map.setCenter(coordinates[0]);

  // Show route stops below map
  const stopsDiv = document.getElementById("route-stops");
  stopsDiv.style.display = "block";
  stopsDiv.innerHTML = "<h3>Route Stops:</h3>" +
    coordinates.map((coord, idx) => `<div>Stop ${idx + 1}: [${coord.lat.toFixed(4)}, ${coord.lng.toFixed(4)}]</div>`).join("");
}

// Load results on page load
window.onload = displayBusRoutes;
